module SpScan

  class XmlVulnerabilitySource

    def initialize(vuln_file)
      @vuln_file = vuln_file
      @vulnerabilities = {}
    end

    def vulnerabilities_for(version)
      @vulnerabilities.fetch(version) { load_vulnerabilities_for(version, vuln_file) }
    end

    private

    attr_reader :vuln_file

    def load_vulnerabilities_for(version, xml_file)
      xml_file = Nokogiri::XML(File.open(vuln_file)) do |config|
        config.noblanks
      end

      vulnerabilities = []

      xml_file.xpath("//sharepoint[@version='#{version.identifier}']/vulnerability").each do |node|
        title = node.search('title').text
        type = node.search('type').text
        references = node.search('reference').map(&:text)
        vulnerabilities << SpScan::Vulnerability.new(title, type, references)
      end
      @vulnerabilities[version]=vulnerabilities
    end
  end
end
